<link rel="import" href="../../bower_components/polymer/polymer.html">

<dom-module id="koa-app">
  <template>
    <content></content>
  </template>
  <script>
    Polymer({
      is: 'koa-app',

      properties: {
        theme: {
          type: String
        },

        tree: {
          type: Array,
          value: []
        },

        _themesPath: {
          type: String,
          value: window.location.origin + '/app/themes/'
        },

        _importedThemes: {
          type: Object,
          value: {}
        }
      },

      createTree: function () {
        this.tree = new Array(0);
        this._processElement(this.children[0]);
      },

      setTheme: function (theme, callback) {
        this.theme = theme;

        var isNotThemeImported = typeof this._importedThemes[this.theme] === 'undefined';

        if (isNotThemeImported) {
          this.importHref(this._getThemePath(), function(e) {
            this.renderThemeElements(callback);
            this._importedThemes[this.theme] = null;
          });
        } else {
          this.renderThemeElements(callback);
        }
      },

      renderThemeElements: function (callback) {
        this.tree.forEach(function(elementObject) {
          this._renderThemeElement(elementObject);
        }, this);

        if (callback) {
          setTimeout(callback, 0);  // nextTick
        }
      },

      _processElement: function (element) {
        var hasChildren = element.children.length > 0;

        if (hasChildren) {
          var children = element.children;

          for (var i = 0; i < children.length; i++) {
            this._processElement(children[i]);
          }
        }

        if (element.tagName) {
          var isKoaElement = element.tagName.toLowerCase().search('koa-') === 0;

          if (isKoaElement) {
            this.tree.push({
              original: element,
              tag: element.tagName.toLowerCase().replace('koa-', ''),
              actual: element
            });
          }
        }
      },

      _createThemeElement: function (tag, element) {
        var newElementName = this.theme + '-' + tag;
        var newElement = document.createElement(newElementName);

        for (var i = 0; i < element.attributes.length; i++) {
          var attribute = element.attributes[i];
          newElement.setAttribute(attribute.nodeName, attribute.nodeValue);
        }

        // Polymer.dom(newElement).innerHTML = Polymer.dom(element).innerHTML;

        var originalChildNodes = Polymer.dom(element).cloneNode(true).childNodes;
        for (var i = 0; i < originalChildNodes.length; i++) {
          Polymer.dom(newElement).appendChild(originalChildNodes[i]);
        }

        return newElement;
      },

      _renderThemeElement: function (element) {
        var parentNode = Polymer.dom(element.actual).parentNode;
        var newElement = this._createThemeElement(element.tag, element.original);

        parentNode.replaceChild(newElement, element.actual);
        element.actual = newElement;
      },

      _getThemePath: function () {
        return this._themesPath + this.theme + '-theme.html';
      }
    });
  </script>
</dom-module>
