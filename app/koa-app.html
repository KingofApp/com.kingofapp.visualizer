<link rel="import" href="bower_components/polymer/polymer.html">

<dom-module id="koa-app">
  <template>
    <content></content>
  </template>
  <script>
    Polymer({
      is: 'koa-app',

      properties: {
        theme: {
          type: String
        },

        tree: {
          type: Array,
          value: []
        },

        _themesPath: {
          type: String,
          value: window.location.origin + '/app/themes/'
        },

        _importedThemes: {
          type: Object,
          value: {}
        }
      },

      createTree: function () {
        this.tree = new Array(0);
        this._processElement(this.children[0]);
      },

      setTheme: function (theme, callback) {
        this.theme = theme;

        var isNotThemeImported = typeof this._importedThemes[this.theme] === 'undefined';

        if (isNotThemeImported) {
          this.importHref(this._getThemePath(), function(e) {
            this.renderThemeElements(callback);
            this._importedThemes[this.theme] = null;
          });
        } else {
          this.renderThemeElements(callback);
        }
      },

      renderThemeElements: function (callback) {
        this.tree.forEach(function(elementObject) {
          this._renderThemeElement(elementObject);
        }, this);

        if (callback) {
          setTimeout(callback, 0);  // nextTick
        }
      },

      _processElement: function (element) {
        var hasChildren = element.children.length > 0;

        if (hasChildren) {
          var children = element.children;

          for (var i = 0; i < children.length; i++) {
            this._processElement(children[i]);
          }
        }

        if (element.tagName) {
          var isKoaElement = element.tagName.toLowerCase().search('koa-') === 0;

          if (isKoaElement) {
            this.tree.push({
              tag: element.tagName.toLowerCase().replace('koa-', ''),
              attributes: element.attributes,
              childNodes: element.childNodes,
              actualElement: element
            });
          }
        }
      },

      _createThemeElement: function (tag, attributes, childNodes, element) {
        var newElementName = this.theme + '-' + tag;
        var newElement = document.createElement(newElementName);

        for (var i = 0; i < attributes.length; i++) {
          var attribute = attributes[i];
          Polymer.dom(newElement).setAttribute(attribute.nodeName, attribute.nodeValue);
        }

        for (var i = 0; i < childNodes.length; i++) {
          var clonedChildNode = Polymer.dom(childNodes[i]).cloneNode(true);
          Polymer.dom(newElement).appendChild(clonedChildNode);
        }

        return newElement;
      },

      _renderThemeElement: function (treeElement) {
        var parentNode = Polymer.dom(treeElement.actualElement).parentNode;
        var newElement = this._createThemeElement(treeElement.tag, treeElement.attributes, treeElement.childNodes);

        Polymer.dom(parentNode).replaceChild(newElement, treeElement.actualElement);
        treeElement.actualElement = newElement;
      },

      _getThemePath: function () {
        return this._themesPath + 'koa-' + this.theme + '-theme/koa-' + this.theme + '-theme.html';
      }
    });
  </script>
</dom-module>
