<link rel="import" href="bower_components/polymer/polymer.html">
<link rel="import" href="bower_components/iron-flex-layout/iron-flex-layout.html">

<dom-module id="koa-app">
  <template>
    <style>
      :host {
        @apply(--layout);
        @apply(--layout-fullbleed);

        background-color: var(--background-color);
        background-image: var(--background-image);
        color: var(--primary-text-color);
        font-family: var(--primary-font-family);
      }

      :host ::content h1,
      :host ::content h2,
      :host ::content h3 {
        font-family: var(--title-font-family);
      }
    </style>

    <content></content>
  </template>
  <script>
    Polymer({
      is: 'koa-app',

      properties: {
        theme: {
          type: String
        },

        tree: {
          type: Array,
          value: []
        }
      },

      themesPath: 'themes',

      importedThemes: [],

      excludedElementsToProcess: [
        'koa-icon'
      ],

      createTree: function () {
        this.tree = new Array(0);
        this._processElement(this.children[0]);
      },

      setTheme: function (theme, callback) {
        this.theme = theme;

        var themeIsNotImported = this.importedThemes.indexOf(this.theme) === -1;

        if (themeIsNotImported) {
          this.importHref(this._getThemePath(), function(e) {
            this.renderThemeElements(callback);
            this.importedThemes.push(this.theme);
          });
        } else {
          this.renderThemeElements(callback);
        }
      },

      renderThemeElements: function (callback) {
        this.tree.forEach(function(elementObject) {
          this._renderThemeElement(elementObject);
        }, this);

        if (callback) {
          setTimeout(callback, 0);  // nextTick
        }
      },

      _processElement: function (element) {
        var hasChildren = element.children.length > 0;

        if (hasChildren) {
          var children = element.children;

          for (var i = 0; i < children.length; i++) {
            this._processElement(children[i]);
          }
        }

        if (element.tagName) {
          var elementTagName = element.tagName.toLowerCase();
          var isKoaElement = elementTagName.search('koa-') === 0;
          var isNotExcludedElement = this.excludedElementsToProcess.indexOf(elementTagName) === -1;

          if (isKoaElement && isNotExcludedElement) {
            this.tree.push({
              tag: elementTagName.replace('koa-', ''),
              attributes: element.attributes,
              childNodes: element.childNodes,
              actualElement: element
            });
          }
        }
      },

      _createThemeElement: function (tag, attributes, childNodes) {
        var newElementName = this.theme.replace('koa-', '').replace('-theme', '') + '-' + tag;
        var newElement = document.createElement(newElementName);

        for (var i = 0; i < attributes.length; i++) {
          var attribute = attributes[i];
          Polymer.dom(newElement).setAttribute(attribute.nodeName, attribute.nodeValue);
        }

        for (var i = 0; i < childNodes.length; i++) {
          var clonedChildNode = Polymer.dom(childNodes[i]).cloneNode(true);

          // Remove the Polymer classes, because they will added next line
          var classList = clonedChildNode.classList;
          if (classList && classList.contains('x-scope')) {
            classList.remove('x-scope');
            var classToRemove = (new RegExp('(' + clonedChildNode.tagName.toLowerCase() + '-)(\\d)')).exec(clonedChildNode.className)[0];
            classList.remove(classToRemove);
          }

          Polymer.dom(newElement).appendChild(clonedChildNode);
        }

        return newElement;
      },

      _renderThemeElement: function (treeElement) {
        var parentNode = Polymer.dom(treeElement.actualElement).parentNode;
        var newElement = this._createThemeElement(treeElement.tag, treeElement.attributes, treeElement.childNodes);

        Polymer.dom(parentNode).replaceChild(newElement, treeElement.actualElement);
        treeElement.actualElement = newElement;
      },

      _getThemePath: function () {
        return this.themesPath + '/' + this.theme + '/dist/' + this.theme + '.html';
      }
    });
  </script>
</dom-module>
