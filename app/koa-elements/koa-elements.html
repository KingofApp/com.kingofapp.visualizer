<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/iron-icons/iron-icons.html">

<!-- Import the koaElements -->
<script src="koa-elements.js"></script>

<script>
  // koa-observe-theme
  var _importedElements = new Array(0);

  Polymer.KoaObserveTheme = {
    properties: {
      parent: {
        type: String
      },

      replaceKoaTags: {
        type: Boolean,
        value: false
      }
    },

    ready: function () {
      this._tag = this.is.replace('koa-', '');
      this._originalInnerHTML = Polymer.dom(this).innerHTML;
      this._originalParentNode = Polymer.dom(this.parentNode);

      this._originalParentNode.removeChild(this);

      koa.theme.onChange(this._themeChanged.bind(this));
    },

    _createElement: function (name) {
      var element = document.createElement(name);

      // Add the attributes and the classes
      for (var i = 0; i < this.attributes.length; i++) {
        var attribute = this.attributes[i];
        element.setAttribute(attribute.nodeName, attribute.nodeValue);
      }

      // Add the content
      for (var i = 0; i < this._contentNodes.length; i++) {
        Polymer.dom(element).appendChild(this._contentNodes[i]);
      }

      return element;
    },

    _renderElement: function (name) {
      var element = this._createElement(name);
      this._previousElement = element;
      this._originalParentNode.appendChild(element);
    },

    _replaceKoaTags: function (html, theme) {
      return html.replace(/(\<)(\/?)(koa)(-)/gm, '<$2' + theme + '-');
    },

    _stringToNodes: function (string) {
      var element = document.createElement('div');
      element.innerHTML = string;
      return element.childNodes;
    },

    _themeChanged: function (theme) {
      var elementFolder = theme + '-' + (this.parent || this._tag);
      var elementName = theme + '-' + this._tag;
      var elementPath = 'bower_components/' + elementFolder + '/' + elementName + '.html';

      if (this._previousElement) {
        this._originalParentNode.removeChild(this._previousElement);
      }

      if (this.replaceKoaTags) {
        var newHtml = this._replaceKoaTags(this._originalInnerHTML, theme);
        this._contentNodes = this._stringToNodes(newHtml);
      } else {
        this._contentNodes = this._stringToNodes(this._originalInnerHTML);
      }

      if ((_importedElements.indexOf(elementName) === -1)) {
        this.importHref(elementPath, function(e) {
          _importedElements.push(elementName);
          this._renderElement(elementName);
        });
      } else {
        this._renderElement(elementName);
      }
    }
  };

  // create the koa-elements
  function createKoaElement(element) {
    var polymerObject = {
      is: element.is,

      behaviors: [
        Polymer.KoaObserveTheme
      ]
    };

    if (element.properties) {
      polymerObject.properties = element.properties;
    }

    Polymer(polymerObject);
  }

  function createKoaElements() {
    koaElements.forEach(function(element) {
      if (element.childs) {
        element.properties = element.properties || {};
        element.properties.replaceKoaTags = {
          value: true
        };

        element.childs.forEach(function(childElement) {
          childElement.properties = childElement.properties || {};

          childElement.properties.parent = {
            value: element.is.replace('koa-', '')
          };

          createKoaElement(childElement);
        });
      }

      createKoaElement(element);
    });
  }

  createKoaElements();
</script>
