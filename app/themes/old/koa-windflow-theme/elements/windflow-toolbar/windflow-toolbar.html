<link rel="import" href="../../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../../../bower_components/iron-flex-layout/iron-flex-layout.html">
<!--
### Styling

Custom property | Description | Default
----------------|-------------|--------
`--toolbar-background` | Toolbar background color | `--default-primary-color`
`--toolbar-color` | Toolbar foreground color | `--text-primary-color`
`--toolbar-height` | Custom height for toolbar | `64px`
`--toolbar-sm-height` | Custom height for small screen toolbar | `56px`
`--toolbar` | Mixin applied to the toolbar | `{}`
-->

<dom-module id="windflow-toolbar">
  <template>
    <style>
        @font-face {
            font-family: 'MullerBold';
            src: url('../fonts/Muller/Muller-ExtraBold-DEMO.otf');
        }
      :host {
        font-family: 'MullerBold';
        display: block;
        position: relative;
        box-sizing: border-box;
        -moz-box-sizing: border-box;
        height: var(--windflow-toolbar-height, 64px);
        background: var(--windflow-toolbar-background, #3F51B5);
        color: var(--windflow-toolbar-color, #FFF);
        @apply(--windflow-toolbar);
      }
      :host(.animate) {
        /* transition */
        transition: height 0.18s ease-in;
      }
      :host(.medium-tall) {
        height: calc(var(--windflow-toolbar-height, 64px) * 2);
        @apply(--windflow-toolbar-medium);
      }
      :host(.tall) {
        height: calc(var(--windflow-toolbar-height, 64px) * 3);
        @apply(--windflow-toolbar-tall);
      }
      .toolbar-tools {
        position: relative;
        height: var(--windflow-toolbar-height, 64px);
        padding: 0 16px;
        pointer-events: none;
        @apply(--layout-horizontal);
        @apply(--layout-center);
      }
      #topBar {
        position: relative;
      }
      /* middle bar */
      #middleBar {
        position: absolute;
        top: 0;
        right: 0;
        left: 0;
      }
      :host(.tall) #middleBar,
      :host(.medium-tall) #middleBar {
        -webkit-transform: translateY(100%);
        transform: translateY(100%);
      }
      /* bottom bar */
      #bottomBar {
        position: absolute;
        right: 0;
        bottom: 0;
        left: 0;
      }
      /*
       * make elements (e.g. buttons) respond to mouse/touch events
       *
       * `.toolbar-tools` disables touch events so multiple toolbars can stack and not
       * absorb events. All children must have pointer events re-enabled to work as
       * expected.
       */
      .toolbar-tools > ::content > *:not([disabled]) {
        pointer-events: auto;
      }
      .toolbar-tools > ::content .title {
        @apply(--windflow-font-common-base);
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        font-size: 20px;
        font-weight: 400;
        line-height: 1;
        pointer-events: none;
        @apply(--layout-flex);
        @apply(--windflow-toolbar-title);
      }
      /**
       * TODO: Refactor these selectors
       * Work in progress.
       */
      .toolbar-tools > ::content windflow-icon-button[icon=menu] {
        margin-right: 24px;
      }
      .toolbar-tools > ::content > .title,
      .toolbar-tools > ::content[select=".middle"] > .title,
      .toolbar-tools > ::content[select=".bottom"] > .title {
        margin-left: 56px;
      }
      .toolbar-tools > ::content > windflow-icon-button + .title,
      .toolbar-tools > ::content[select=".middle"] windflow-icon-button + .title,
      .toolbar-tools > ::content[select=".bottom"] windflow-icon-button + .title {
        margin-left: 0;
      }
      .toolbar-tools > ::content > .fit {
        position: absolute;
        top: auto;
        right: 0;
        bottom: 0;
        left: 0;
        width: auto;
        margin: 0;
      }
      /* TODO(noms): Until we have a better solution for classes that don't use
       * /deep/ create our own.
       */
      .start-justified {
        @apply(--layout-start-justified);
      }
      .center-justified {
        @apply(--layout-center-justified);
      }
      .end-justified {
        @apply(--layout-end-justified);
      }
      .around-justified {
        @apply(--layout-around-justified);
      }
      .justified {
        @apply(--layout-justified);
      }
    </style>    

    <div id="topBar" class$="toolbar-tools [[_computeBarExtraClasses(justify)]]">
      <content select=":not(.middle):not(.bottom)"></content>
    </div>

    <div id="middleBar" class$="toolbar-tools [[_computeBarExtraClasses(middleJustify)]]">
      <content select=".middle"></content>
    </div>

    <div id="bottomBar" class$="toolbar-tools [[_computeBarExtraClasses(bottomJustify)]]">
      <content select=".bottom"></content>
    </div>
  </template>
  <script>
    
    Polymer({
      is: 'windflow-toolbar',
      hostAttributes: {
        'role': 'toolbar'
      },
      properties: {
        /**
         * Controls how the items are aligned horizontally when they are placed
         * at the bottom.
         * Options are `start`, `center`, `end`, `justified` and `around`.
         *
         * @attribute bottomJustify
         * @type string
         * @default ''
         */
        bottomJustify: {
          type: String,
          value: ''
        },
        /**
         * Controls how the items are aligned horizontally.
         * Options are `start`, `center`, `end`, `justified` and `around`.
         *
         * @attribute justify
         * @type string
         * @default ''
         */
        justify: {
          type: String,
          value: ''
        },
        /**
         * Controls how the items are aligned horizontally when they are placed
         * in the middle.
         * Options are `start`, `center`, `end`, `justified` and `around`.
         *
         * @attribute middleJustify
         * @type string
         * @default ''
         */
        middleJustify: {
          type: String,
          value: ''
        }
      },
      attached: function() {
        this._observer = this._observe(this);
        this._updateAriaLabelledBy();
      },
      detached: function() {
        if (this._observer) {
          this._observer.disconnect();
        }
      },
      _observe: function(node) {
        var observer = new MutationObserver(function() {
          this._updateAriaLabelledBy();
        }.bind(this));
        observer.observe(node, {
          childList: true,
          subtree: true
        });
        return observer;
      },
      _updateAriaLabelledBy: function() {
        var labelledBy = [];
        var contents = Polymer.dom(this.root).querySelectorAll('content');
        for (var content, index = 0; content = contents[index]; index++) {
          var nodes = Polymer.dom(content).getDistributedNodes();
          for (var node, jndex = 0; node = nodes[jndex]; jndex++) {
            if (node.classList && node.classList.contains('title')) {
              if (node.id) {
                labelledBy.push(node.id);
              } else {
                var id = 'windflow-toolbar-label-' + Math.floor(Math.random() * 10000);
                node.id = id;
                labelledBy.push(id);
              }
            }
          }
        }
        if (labelledBy.length > 0) {
          this.setAttribute('aria-labelledby', labelledBy.join(' '));
        }
      },
      _computeBarExtraClasses: function(barJustify) {
        if (!barJustify) return '';
        return barJustify + (barJustify === 'justified' ? '' : '-justified');
      }
    });
  </script>
</dom-module>
